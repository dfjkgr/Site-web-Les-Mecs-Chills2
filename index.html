<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Manoir de l'Énigme Hantée - Halloween</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et sombre -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Configuration de Tailwind pour un thème Halloween */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'halloween-orange': '#ff6600',
                        'midnight-black': '#0a0a0a',
                        'blood-red': '#cc0000',
                        'swamp-green': '#008000',
                        'bone-white': '#fefefe',
                        'rust-brown': '#7c4c00',
                    },
                    fontFamily: {
                        display: ['Creepster', 'cursive'], /* Police effrayante pour les titres */
                        sans: ['Inter', 'sans-serif'], /* Police lisible pour le corps du texte */
                    },
                    boxShadow: {
                        'spooky-glow': '0 0 15px rgba(255, 102, 0, 0.7), 0 0 10px rgba(204, 0, 0, 0.5)',
                        'inner-horror': 'inset 0 0 10px rgba(0, 0, 0, 0.9)',
                    }
                }
            }
        }

        /* Styles personnalisés pour l'ambiance sombre et rouillée */
        body {
            background-color: #1a1a1a;
            color: #fefefe;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* Style pour l'écran principal du manoir */
        #game-container {
            min-height: calc(100vh - 80px); /* Ajustement pour la barre de titre */
        }

        /* Style des boutons de jeu */
        .game-button {
            transition: all 0.3s ease;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            border: 2px solid #ff6600;
        }
        .game-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #ff6600;
            background-color: #7c4c00; /* Rust Brown */
        }

        /* Style des titres effrayants */
        .spooky-title {
            font-family: 'Creepster', cursive;
            color: #ff6600;
            text-shadow: 2px 2px 5px #cc0000, 0 0 10px #ff6600;
        }

        /* Animation pour l'icône de musique */
        .spin {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="selection:bg-halloween-orange selection:text-midnight-black">

    <!-- Élément Audio pour la musique (Ajouter l'URL source ici) -->
    <audio id="background-music" loop>
        <!-- REMPLACER CETTE SOURCE par une URL de musique d'ambiance d'Halloween libre de droits -->
        <!-- Par exemple: <source src="chemin/vers/votre/musique.mp3" type="audio/mp3"> -->
        Votre navigateur ne supporte pas l'élément audio.
    </audio>

    <!-- En-tête du Manoir -->
    <header class="bg-midnight-black border-b border-rust-brown/50 shadow-spooky-glow p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="spooky-title text-4xl lg:text-5xl">
                Le Manoir de l'Énigme
            </h1>
            <div class="flex items-center space-x-4">
                <!-- Bouton de Musique -->
                <button id="music-toggle" onclick="toggleMusic()" class="text-bone-white bg-rust-brown/70 p-2 rounded-full hover:bg-rust-brown transition duration-200" title="Activer/Désactiver la Musique">
                    <svg id="music-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>
                </button>
                <!-- Affichage du Score -->
                <div id="score-display" class="text-xl font-bold text-swamp-green bg-rust-brown/50 px-4 py-1 rounded-full border border-halloween-orange/50 shadow-inner-horror">
                    Score : 0
                </div>
            </div>
        </div>
    </header>

    <!-- Conteneur Principal du Jeu -->
    <main id="game-container" class="max-w-4xl mx-auto p-6 flex flex-col items-center justify-center">
        <!-- Le contenu dynamique sera injecté ici -->
    </main>

    <!-- Modale de Message (pour remplacer alert()) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-rust-brown border-4 border-blood-red p-8 rounded-xl shadow-spooky-glow max-w-sm w-full text-center">
            <h3 id="modal-title" class="spooky-title text-3xl mb-4 text-halloween-orange">Message</h3>
            <p id="modal-message" class="text-bone-white mb-6 text-lg"></p>
            <button onclick="hideModal()" class="game-button bg-blood-red hover:bg-blood-red/80 text-bone-white font-bold py-2 px-4 rounded-lg">
                Fermer
            </button>
        </div>
    </div>

    <script>
        // Initialisation de l'état du jeu
        let gameState = {
            currentScreen: 'home',
            score: 0,
            hasKey: false,
            quizAnswered: false,
            riddleSolved: false,
            codeEntered: false,
            userName: 'Voyageur Mystère',
        };

        // --- Fonctions Audio ---
        const music = document.getElementById('background-music');
        const musicIcon = document.getElementById('music-icon');

        function toggleMusic() {
            if (music.paused) {
                // Tente de jouer. Peut échouer si le navigateur bloque l'autoplay sans interaction.
                music.play().catch(error => {
                    console.error("Erreur de lecture audio :", error);
                    showModal("Musique", "Le navigateur pourrait avoir bloqué la lecture automatique. Cliquez à nouveau ou interagissez avec la page.");
                });
                musicIcon.outerHTML = '<svg id="music-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2 spin"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>';
            } else {
                music.pause();
                musicIcon.outerHTML = '<svg id="music-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>';
            }
        }

        // --- Configuration des jeux et énigmes ---
        const SCREENS = {
            home: {
                title: "Bienvenue dans le Manoir Hanté",
                content: `
                    <p class="text-lg mb-6 text-center">
                        La légende raconte que ce manoir n'ouvre ses portes qu'à ceux qui ont le courage de résoudre ses énigmes. Pour vous échapper avant le lever du jour, vous devez obtenir la Clé du Salut.
                    </p>
                    <p class="text-lg mb-8 text-center spooky-title text-2xl">
                        Êtes-vous prêt à commencer votre aventure ?
                    </p>
                `,
                actions: [
                    { text: "Entrer dans l'Antichambre", next: 'antichamber' }
                ]
            },
            antichamber: {
                title: "L'Antichambre Poussiéreuse (Pièce 1)",
                content: `
                    <p class="text-lg mb-4">
                        Une faible lueur d'une bougie vacillante éclaire cette pièce. Il y a **trois** portes.
                        La porte au nord mène à un **BUREAU** où une histoire semble s'être arrêtée brusquement.
                        La porte à l'est semble bloquée par une force invisible.
                        La porte à l'ouest mène à une **CUISINE** avec une odeur de soufre et de sucreries.
                    </p>
                    <div class="mt-4 p-3 bg-midnight-black/70 border border-blood-red rounded-lg text-center font-bold text-lg">
                        NOTE: C'est la **première pièce** de votre exploration. Le chiffre **1** est un indice !
                    </div>
                `,
                actions: [
                    { text: "Aller au BUREAU (Quiz)", next: 'quiz' },
                    { text: "Aller à la CUISINE (Énigme)", next: 'riddle' },
                    { text: "Porte Est (Verrouillée)", next: 'vault' }
                ]
            },
            quiz: {
                title: "Le Bureau du Savoir Maudit (Indice 1)",
                content: `
                    <p class="text-xl mb-6 spooky-title text-halloween-orange">
                        Un vieux livre s'ouvre de lui-même. Répondez correctement à la question pour trouver le premier chiffre.
                    </p>
                    <p class="text-lg mb-4 font-bold text-center">
                        Question : Combien y a-t-il de jours entre le 24 octobre et le 31 octobre (inclus) ?
                    </p>
                    <div id="quiz-options" class="flex flex-col space-y-4">
                        <button onclick="checkQuiz('wrong')" class="quiz-button game-button">Cinq (5)</button>
                        <button onclick="checkQuiz('correct')" class="quiz-button game-button">Huit (8)</button>
                        <button onclick="checkQuiz('wrong')" class="quiz-button game-button">Sept (7)</button>
                    </div>
                `,
                actions: [
                    { text: "Retour à l'Antichambre", next: 'antichamber' }
                ]
            },
            riddle: {
                title: "La Cuisine des Maléfices (Indice 2)",
                content: `
                    <p class="text-xl mb-6 spooky-title text-halloween-orange">
                        Un chaudron bouillonne tout seul. Une note rouillée y est attachée (Énigme facile !) :
                    </p>
                    <div class="bg-midnight-black p-4 rounded-lg border border-swamp-green mb-6 text-center text-lg italic">
                        "J'ai une tête mais pas de corps, j'ai une bouche mais jamais je ne parle. On me sculpte pour la nuit d'Halloween. Qui suis-je ?"
                    </div>
                    <input type="text" id="riddle-input" placeholder="Votre réponse ici (un mot simple)..." class="w-full p-3 rounded-lg bg-gray-800 text-bone-white placeholder-gray-500 mb-4 focus:outline-none focus:ring-2 focus:ring-halloween-orange">
                    <button onclick="checkRiddle()" id="riddle-button" class="game-button bg-swamp-green hover:bg-swamp-green/80 text-bone-white font-bold py-3 px-6 rounded-lg mb-6 w-full">
                        Soumettre la Réponse
                    </button>
                `,
                actions: [
                    { text: "Retour à l'Antichambre", next: 'antichamber' }
                ]
            },
            vault: {
                title: "La Porte Scellée",
                content: `
                    <p class="text-lg mb-6">
                        La Porte Est est recouverte de symboles étranges. Vous trouvez une console numérique pour entrer un code à trois chiffres.
                        Le code est la combinaison des indices : **Indice 1 (Bureau) + Indice 2 (Cuisine) + Indice 3 (Antichambre).**
                    </p>
                    <div id="vault-status" class="text-center text-xl mb-4 font-bold"></div>
                    <input type="number" id="code-input" placeholder="Entrez le code à 3 chiffres" maxlength="3" class="w-full p-3 rounded-lg bg-gray-800 text-bone-white placeholder-gray-500 mb-4 text-center text-2xl focus:outline-none focus:ring-2 focus:ring-halloween-orange">
                    <button onclick="checkVaultCode()" id="code-button" class="game-button bg-blood-red hover:bg-blood-red/80 text-bone-white font-bold py-3 px-6 rounded-lg w-full">
                        Activer le Sceau
                    </button>
                `,
                actions: [
                    { text: "Retour à l'Antichambre", next: 'antichamber' }
                ]
            },
            escape: {
                title: "LA CLÉ DU SALUT !",
                content: `
                    <p class="text-3xl mb-8 text-center text-swamp-green spooky-title">
                        Félicitations, ${gameState.userName} !
                    </p>
                    <p class="text-xl mb-6 text-center">
                        La porte s'est ouverte et la Clé du Salut brille devant vous. Vous vous échappez du Manoir de l'Énigme avec un score final de **${gameState.score}** !
                    </p>
                    <img src="https://placehold.co/400x200/ff6600/0a0a0a?text=CL%C9+GAGN%C9E" alt="Clé dorée d'évasion" class="mx-auto my-6 rounded-lg shadow-spooky-glow">

                    <!-- Nouveau message pour le concours -->
                    <div class="mt-8 p-4 border-2 border-halloween-orange rounded-lg bg-midnight-black/70">
                        <h3 class="spooky-title text-2xl text-center mb-3">Concours de l'Énigme Hantée</h3>
                        <p class="text-lg text-center font-bold text-bone-white">
                            **Votre Score : ${gameState.score}**
                        </p>
                        <p class="text-center mt-2">
                            Envoyez votre score dans le **Salon Site Halloween** pour obtenir votre classement ! Un nouveau site/énigme sera disponible tous les 5 jours avant le 31 octobre, avec un grand final pour Halloween ! Bonne chance !
                        </p>
                    </div>
                `,
                actions: [
                    { text: "Recommencer l'Aventure", next: 'reset' }
                ]
            }
        };

        // --- Fonctions Utilitaires ---

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        function updateScore(amount) {
            gameState.score += amount;
            // Si l'utilisateur est sur l'écran final, le contenu doit être mis à jour après la résolution du code
            if (gameState.currentScreen === 'escape') {
                renderScreen('escape'); // Re-rend l'écran d'évasion pour mettre à jour le score dans le message du concours
            }
            document.getElementById('score-display').textContent = `Score : ${gameState.score}`;
            if (amount > 0) {
                // Montre la modale uniquement pour les gains positifs hors de l'écran d'évasion
                if (gameState.currentScreen !== 'escape') {
                    showModal("Succès ! (+${amount})", "Vous avez trouvé une pièce d'or !");
                }
            }
        }

        function resetGame() {
            gameState = {
                currentScreen: 'home',
                score: 0,
                hasKey: false,
                quizAnswered: false,
                riddleSolved: false,
                codeEntered: false,
                userName: gameState.userName, // Garde le nom de l'utilisateur
            };
            music.pause();
            music.currentTime = 0;
            musicIcon.outerHTML = '<svg id="music-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>';
            renderScreen(gameState.currentScreen);
            updateScore(0); // Met à jour l'affichage du score à 0
        }

        // --- Logique du Jeu (Les Énigmes) ---

        function checkQuiz(result) {
            if (gameState.quizAnswered) {
                showModal("Déjà Fait", "Vous avez déjà répondu à cette question et obtenu votre récompense.");
                return;
            }

            // Réponse correcte au quiz: 8 jours. Indice: 8.
            if (result === 'correct') {
                updateScore(50);
                gameState.quizAnswered = true;
                // Indice 1: 8
                showModal("Réponse Correcte !", "Indice 1 trouvé: Le chiffre '8'.");
                document.getElementById('quiz-options').innerHTML = '<p class="text-lg text-swamp-green font-bold">Quiz Résolu ! Indice 1: **8**</p>';
            } else {
                updateScore(-5);
                showModal("Mauvaise Réponse", "Une petite douleur vous traverse l'esprit. Réessayez.");
            }
            // Désactive les boutons après la première tentative pour le quiz
            document.querySelectorAll('.quiz-button').forEach(btn => btn.onclick = () => showModal("Attention", "Le livre ne vous laissera pas tricher."));
        }

        function checkRiddle() {
            if (gameState.riddleSolved) {
                showModal("Déjà Fait", "L'énigme a déjà été résolue.");
                return;
            }

            const answer = document.getElementById('riddle-input').value.trim().toLowerCase();
            // Liste d'acceptation de réponses faciles pour citrouille
            const correctAnswers = ['citrouille', 'la citrouille', 'pumpkin', 'jack-o-lantern', 'lanterne'];

            if (correctAnswers.some(correct => answer.includes(correct))) {
                updateScore(75);
                gameState.riddleSolved = true;
                // Indice 2: 3 (un chiffre simple pour suivre le 8)
                showModal("Énigme Résolue !", "Indice 2 trouvé: Le chiffre '3'.");
                document.getElementById('riddle-button').disabled = true;
                document.getElementById('riddle-button').textContent = 'Résolu !';
                document.getElementById('riddle-input').disabled = true;
                // Ajoute l'indice au contenu
                document.querySelector('.bg-midnight-black.p-4').insertAdjacentHTML('afterend', '<p class="text-lg text-swamp-green font-bold text-center mt-4">Énigme Résolue ! Indice 2: **3**</p>');
            } else {
                updateScore(-10);
                showModal("Incorrect", "Le chaudron bouillonne avec rage. Réfléchissez mieux.");
            }
        }

        function checkVaultCode() {
            const vaultStatus = document.getElementById('vault-status');
            const codeInput = document.getElementById('code-input');
            const codeButton = document.getElementById('code-button');

            if (!gameState.quizAnswered || !gameState.riddleSolved) {
                vaultStatus.className = 'text-center text-xl mb-4 font-bold text-blood-red';
                vaultStatus.textContent = "VERROUILLÉ : Manque d'indices (Bureau et Cuisine non résolus).";
                return;
            }

            if (gameState.codeEntered) {
                vaultStatus.className = 'text-center text-xl mb-4 font-bold text-swamp-green';
                vaultStatus.textContent = "OUVERT : La Clé est à vous !";
                renderScreen('escape');
                return;
            }

            const enteredCode = codeInput.value.trim();
            // Code final: Indice 1 (8) + Indice 2 (3) + Indice 3 (1, pour la Première Pièce)
            const CORRECT_CODE = '831';

            if (enteredCode === CORRECT_CODE) {
                updateScore(150);
                gameState.codeEntered = true;
                gameState.hasKey = true;
                vaultStatus.className = 'text-center text-xl mb-4 font-bold text-swamp-green';
                vaultStatus.textContent = "OUVERT ! La Clé du Salut est apparue !";
                codeInput.disabled = true;
                codeButton.textContent = 'Prendre la Clé et S\'Échapper';
                codeButton.onclick = () => renderScreen('escape');
            } else {
                updateScore(-20);
                vaultStatus.className = 'text-center text-xl mb-4 font-bold text-blood-red';
                vaultStatus.textContent = "CODE INCORRECT. Le sceau gronde et vous pénalise. (Avez-vous bien combiné l'indice 8, l'indice 3, et l'indice de l'Antichambre 1 ?)";
            }
        }

        // --- Moteur de Rendu ---

        function renderScreen(screenKey) {
            // Logique de réinitialisation si l'utilisateur choisit de recommencer
            if (screenKey === 'reset') {
                resetGame();
                return;
            }

            const screen = SCREENS[screenKey];
            const container = document.getElementById('game-container');
            container.innerHTML = ''; // Nettoyer le contenu précédent

            // 1. Mise à jour de l'état
            gameState.currentScreen = screenKey;

            // 2. Créer la structure de la pièce
            const roomDiv = document.createElement('div');
            roomDiv.className = 'w-full bg-rust-brown/50 border-4 border-rust-brown rounded-2xl p-8 shadow-spooky-glow animate-fadeIn';
            roomDiv.style.animation = 'fadeIn 1s ease-out';

            // 3. Ajouter le titre de la pièce
            roomDiv.innerHTML += `<h2 class="spooky-title text-4xl mb-6 text-center">${screen.title}</h2>`;

            // 4. Ajouter le contenu de la pièce
            roomDiv.innerHTML += `<div class="content-area mb-8">${screen.content}</div>`;

            // 5. Ajouter les boutons d'action/navigation
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex flex-col md:flex-row justify-center gap-4';

            screen.actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'game-button bg-halloween-orange text-bone-white font-bold py-3 px-6 rounded-lg shadow-md';
                button.textContent = action.text;

                // Logique pour gérer les portes verrouillées
                if (action.next === 'vault') {
                    if (gameState.hasKey) {
                        button.textContent = "Porte Est (Déverrouillée - Évasion!)";
                        button.onclick = () => renderScreen('escape');
                    } else {
                         // On gère la logique de la Porte Est dans checkVaultCode()
                         button.onclick = () => renderScreen(action.next);
                    }
                } else if (action.next === 'quiz') {
                    button.onclick = () => renderScreen(action.next);
                    if (gameState.quizAnswered) {
                        button.classList.add('opacity-50', 'cursor-not-allowed', 'bg-swamp-green/50');
                        button.textContent = "Aller au BUREAU (Résolu)";
                    }
                } else if (action.next === 'riddle') {
                    button.onclick = () => renderScreen(action.next);
                    if (gameState.riddleSolved) {
                        button.classList.add('opacity-50', 'cursor-not-allowed', 'bg-swamp-green/50');
                        button.textContent = "Aller à la CUISINE (Résolu)";
                    }
                } else {
                    button.onclick = () => renderScreen(action.next);
                }

                actionsDiv.appendChild(button);
            });

            roomDiv.appendChild(actionsDiv);
            container.appendChild(roomDiv);

            // 6. Logique post-rendu pour certains écrans
            if (screenKey === 'quiz' && gameState.quizAnswered) {
                // Mettre à jour l'affichage après un rafraîchissement
                document.getElementById('quiz-options').innerHTML = '<p class="text-lg text-swamp-green font-bold">Quiz Résolu ! Indice 1: **8**</p>';
            }

            if (screenKey === 'riddle' && gameState.riddleSolved) {
                document.getElementById('riddle-button').disabled = true;
                document.getElementById('riddle-button').textContent = 'Résolu !';
                document.getElementById('riddle-input').disabled = true;
                document.querySelector('.bg-midnight-black.p-4').insertAdjacentHTML('afterend', '<p class="text-lg text-swamp-green font-bold text-center mt-4">Énigme Résolue ! Indice 2: **3**</p>');
            }

            if (screenKey === 'vault' && gameState.codeEntered) {
                document.getElementById('vault-status').className = 'text-center text-xl mb-4 font-bold text-swamp-green';
                document.getElementById('vault-status').textContent = "OUVERT : La Clé est à vous !";
                document.getElementById('code-input').disabled = true;
                document.getElementById('code-button').textContent = 'Prendre la Clé et S\'Échapper';
                document.getElementById('code-button').onclick = () => renderScreen('escape');
            }
        }

        // --- Démarrage de l'Application ---
        window.onload = () => {
            // Demander un nom pour personnaliser la fin
            const name = prompt("Entrez votre nom pour marquer votre passage dans ce manoir :");
            if (name && name.trim().length > 0) {
                gameState.userName = name.trim();
            }

            renderScreen('home');
        };

        // Ajout d'une animation simple de fondu en entrée
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
